<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Monitorización</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

      body {
        margin: 0;
        font-family: 'Inter', sans-serif;
        background: #f0f2f5;
        color: #333;
      }

      header {
        background: #1f2937;
        color: #f9fafb;
        padding: 20px;
        font-size: 28px;
        font-weight: 700;
        text-align: center;
        letter-spacing: 1px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
      }

      .container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
        gap: 30px;
        padding: 30px;
      }

      .card {
        background: #ffffff;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s ease;
      }

      .card:hover {
        transform: translateY(-4px);
      }

      .title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #111827;
      }

      canvas {
        max-height: 260px;
      }

      .metrics {
        display: flex;
        justify-content: space-around;
        margin-top: 15px;
        gap: 15px;
        flex-wrap: wrap;
      }

      .metric {
        flex: 1;
        min-width: 80px;
        background: #f9fafb;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        box-shadow: inset 0 -1px 3px rgba(0, 0, 0, 0.05);
        transition: background 0.2s;
      }

      .metric span {
        display: block;
        font-size: 22px;
        font-weight: 700;
        margin-top: 5px;
        color: #111827;
      }

      .metric:hover {
        background: #e5e7eb;
      }
    </style>
  </head>
  <body>
    <header>Monitorización</header>

    <div
      style="
        padding: 18px 30px 2px 30px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
      "
    >
      <label for="periodSelect" style="font-size: 14px; color: #4b5563">Periodo:</label>
      <select
        id="periodSelect"
        onchange="onPeriodChange(event)"
        style="padding: 4px 8px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 14px"
      >
        <option value="10">Últimos 10 min</option>
        <option value="30">Últimos 30 min</option>
        <option value="60" selected>Última hora</option>
        <option value="180">Últimas 3 horas</option>
        <option value="360">Últimas 6 horas</option>
        <option value="720">Últimas 12 horas</option>
        <option value="1440">Último día</option>
        <option value="10080">Última semana</option>
        <option value="all">Todo</option>
      </select>
    </div>

    <div class="container">
      <!-- Tarjetas métricas -->
      <div class="card">
        <div class="title">Métricas en tiempo real</div>
        <div class="metrics">
          <div class="metric">CPU<br /><span id="cpuVal">0</span>%</div>
          <div class="metric">RAM<br /><span id="ramVal">0</span>%</div>
          <div class="metric">Disco<br /><span id="diskVal">0</span>%</div>
          <div class="metric">I/O Wait<br /><span id="ioWaitVal">0</span>%</div>
        </div>
      </div>

      <!-- Gráficos -->
      <div class="card">
        <div class="title">CPU (%)</div>
        <canvas id="cpuChart"></canvas>
      </div>

      <div class="card">
        <div class="title">Memoria (%)</div>
        <canvas id="memChart"></canvas>
      </div>

      <div class="card">
        <div class="title">Disco (%)</div>
        <canvas id="diskChart"></canvas>
      </div>

      <div class="card">
        <div class="title">Disco I/O (KB/s)</div>
        <canvas id="diskIOChart"></canvas>
      </div>

      <div class="card">
        <div class="title">Red (KB/s)</div>
        <canvas id="netChart"></canvas>
      </div>
    </div>

    <script>
      let selectedMinutes = 40

      function onPeriodChange(ev) {
        const value = ev.target.value
        if (value === 'all') {
          selectedMinutes = null
        } else {
          const num = parseInt(value, 10)
          selectedMinutes = Number.isFinite(num) && num > 0 ? num : null
        }
        refreshDashboard()
      }

      async function loadHistory() {
        try {
          const url = selectedMinutes
            ? `/api/history?minutes=${encodeURIComponent(selectedMinutes)}`
            : '/api/history'
          const res = await fetch(url)
          if (!res.ok) {
            console.error('Error HTTP al cargar historial:', res.status)
            return []
          }
          return await res.json()
        } catch (err) {
          console.error('Error de red al cargar historial:', err)
          return []
        }
      }

      function formatTimestamp(ts) {
        const date = new Date(ts)
        return date.toLocaleTimeString('es-ES', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        })
      }

      function createChart(ctx, label, labels, values, color, fixedMin = null, fixedMax = null) {
        const yOptions = { beginAtZero: true }

        if (fixedMin !== null) yOptions.min = fixedMin
        if (fixedMax !== null) yOptions.max = fixedMax

        return new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label,
                data: values,
                borderColor: color,
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: { x: { ticks: { maxRotation: 0, minRotation: 0 } }, y: yOptions },
            plugins: { legend: { display: false } }
          }
        })
      }

      let charts = {}

      async function refreshDashboard() {
        const h = await loadHistory()
        if (!h.length) return

        const labels = h.map((i) => formatTimestamp(i.timestamp))
        const cpu = h.map((i) => i.cpu)
        const mem = h.map((i) => (i.mem_used / i.mem_total) * 100)
        const disk = h.map((i) => i.disk_use_percent)
        const diskIO = h.map((i) => {
          const hasRates =
            Number.isFinite(i.disk_read_kb_s) || Number.isFinite(i.disk_write_kb_s)

          if (hasRates) {
            return (i.disk_read_kb_s || 0) + (i.disk_write_kb_s || 0)
          }

          // Fallback: si el backend aún no envía *_kb_s, usar los contadores acumulados
          return ((i.disk_read_bytes || 0) + (i.disk_write_bytes || 0)) / 1024
        })
        const net = h.map((i) => (i.net_rx + i.net_tx) / 1024)

        const latest = h[h.length - 1]

        document.getElementById('cpuVal').innerText = latest.cpu.toFixed(1)
        document.getElementById('ramVal').innerText = (
          (latest.mem_used / latest.mem_total) *
          100
        ).toFixed(1)
        document.getElementById('diskVal').innerText = latest.disk_use_percent.toFixed(1)
        document.getElementById('ioWaitVal').innerText = latest.disk_io_wait.toFixed(1)

        if (!charts.cpu) {
          charts.cpu = createChart(cpuChart, 'CPU (%)', labels, cpu, '#3b82f6', 0, 100)
        } else {
          charts.cpu.data.labels = labels
          charts.cpu.data.datasets[0].data = cpu
          charts.cpu.update()
        }

        if (!charts.mem) {
          charts.mem = createChart(memChart, 'Memoria (%)', labels, mem, '#10b981', 0, 100)
        } else {
          charts.mem.data.labels = labels
          charts.mem.data.datasets[0].data = mem
          charts.mem.update()
        }

        if (!charts.disk) {
          charts.disk = createChart(diskChart, 'Disco (%)', labels, disk, '#8b5cf6', 0, 100)
        } else {
          charts.disk.data.labels = labels
          charts.disk.data.datasets[0].data = disk
          charts.disk.update()
        }

        if (!charts.diskIO) {
          charts.diskIO = createChart(diskIOChart, 'Disco I/O (KB/s)', labels, diskIO, '#f97316')
        } else {
          charts.diskIO.data.labels = labels
          charts.diskIO.data.datasets[0].data = diskIO
          charts.diskIO.update()
        }

        if (!charts.net) {
          charts.net = createChart(netChart, 'Red (KB/s)', labels, net, '#ef4444')
        } else {
          charts.net.data.labels = labels
          charts.net.data.datasets[0].data = net
          charts.net.update()
        }
      }

      refreshDashboard()
      setInterval(refreshDashboard, 10000)
    </script>
  </body>
</html>
